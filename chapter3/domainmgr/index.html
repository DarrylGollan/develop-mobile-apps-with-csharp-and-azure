



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter3/domainmgr/">
      
      
        <meta name="author" content="Adrian Hall">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.3.0">
    
    
      
        <title>The Domain Manager - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.962652e9.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    
      
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-93366112-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-93366112-1")</script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#the-domain-manager" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/" title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
              </span>
              <span class="md-header-nav__topic">
                The Domain Manager
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/" title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Chapter 1 - Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Chapter 1 - Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_pc/" title="Your First App - PC Edition" class="md-nav__link">
      Your First App - PC Edition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_mac/" title="Your First App - Mac Edition" class="md-nav__link">
      Your First App - Mac Edition
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Chapter 2 - Authentication
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Chapter 2 - Authentication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/authconcepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/backend/" title="Authentication in the Backend" class="md-nav__link">
      Authentication in the Backend
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/enterprise/" title="Enterprise Authentication" class="md-nav__link">
      Enterprise Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/social/" title="Social Authentication" class="md-nav__link">
      Social Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/debugging/" title="Debugging Authentication" class="md-nav__link">
      Debugging Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/custom/" title="Custom Authentication" class="md-nav__link">
      Custom Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/authorization/" title="Claims and Authorization" class="md-nav__link">
      Claims and Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/realworld/" title="Tokens in Real Apps" class="md-nav__link">
      Tokens in Real Apps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/bestpractices/" title="Best Practices" class="md-nav__link">
      Best Practices
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Chapter 3 - Data Access and Offline Sync
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Chapter 3 - Data Access and Offline Sync
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dataconcepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../server/" title="Implementing Table Controllers" class="md-nav__link">
      Implementing Table Controllers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../projection/" title="Data Projection and Queries" class="md-nav__link">
      Data Projection and Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../client/" title="The Mobile Client" class="md-nav__link">
      The Mobile Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relationships/" title="Relationships" class="md-nav__link">
      Relationships
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        The Domain Manager
      </label>
    
    <a href="./" title="The Domain Manager" class="md-nav__link md-nav__link--active">
      The Domain Manager
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#existing-table-relationships-with-the-mappedentitydomainmanager" title="Existing Table Relationships with the MappedEntityDomainManager" class="md-nav__link">
    Existing Table Relationships with the MappedEntityDomainManager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nosql-storage-with-the-storagedomainmanager" title="NoSQL Storage with the StorageDomainManager" class="md-nav__link">
    NoSQL Storage with the StorageDomainManager
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#limitations-of-the-azure-storage-domain-manager" title="Limitations of the Azure Storage Domain Manager" class="md-nav__link">
    Limitations of the Azure Storage Domain Manager
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Chapter 4 - Server Side Code
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Chapter 4 - Server Side Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/options/" title="Options for Server Code" class="md-nav__link">
      Options for Server Code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/custom/" title="Custom HTTP Endpoints" class="md-nav__link">
      Custom HTTP Endpoints
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/webjobs/" title="WebJobs" class="md-nav__link">
      WebJobs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/functions/" title="Functions" class="md-nav__link">
      Functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/recipes/" title="Recipes" class="md-nav__link">
      Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Chapter 5 - Push Notifications
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Chapter 5 - Push Notifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/android/" title="Android Push" class="md-nav__link">
      Android Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/ios/" title="iOS Push" class="md-nav__link">
      iOS Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/windows/" title="Windows Push" class="md-nav__link">
      Windows Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/recipes/" title="Push Recipes" class="md-nav__link">
      Push Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Chapter 6 - Combining Web and Mobile Apps
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Chapter 6 - Combining Web and Mobile Apps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/mvc/" title="MVC Applications" class="md-nav__link">
      MVC Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/jquery/" title="jQuery Applications" class="md-nav__link">
      jQuery Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/angular/" title="Angular Applications" class="md-nav__link">
      Angular Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/react/" title="React Applications" class="md-nav__link">
      React Applications
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Chapter 7 - Other Useful Services
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Chapter 7 - Other Useful Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/services/" title="Useful Azure Services" class="md-nav__link">
      Useful Azure Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/search/" title="Azure Search" class="md-nav__link">
      Azure Search
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/media/" title="Media Services" class="md-nav__link">
      Media Services
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Chapter 8 - Developing An App
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Chapter 8 - Developing An App
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/developing/" title="The Development Environment" class="md-nav__link">
      The Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/testing/" title="Testing your Application" class="md-nav__link">
      Testing your Application
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Chapter 9 - Going to Production
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Chapter 9 - Going to Production
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/arm/" title="Repeatable Deployments" class="md-nav__link">
      Repeatable Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/appsvc/" title="Safe Deployments" class="md-nav__link">
      Safe Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/monitoring/" title="Monitoring and Troubleshooting" class="md-nav__link">
      Monitoring and Troubleshooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../xamarin_tips/" title="Xamarin Forms Tips" class="md-nav__link">
      Xamarin Forms Tips
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../android_appendix/" title="Android Developer Notes" class="md-nav__link">
      Android Developer Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../vs_extensions/" title="Visual Studio Extensions" class="md-nav__link">
      Visual Studio Extensions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../references/" title="References" class="md-nav__link">
      References
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../credits/" title="Credits" class="md-nav__link">
      Credits
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#existing-table-relationships-with-the-mappedentitydomainmanager" title="Existing Table Relationships with the MappedEntityDomainManager" class="md-nav__link">
    Existing Table Relationships with the MappedEntityDomainManager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nosql-storage-with-the-storagedomainmanager" title="NoSQL Storage with the StorageDomainManager" class="md-nav__link">
    NoSQL Storage with the StorageDomainManager
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#limitations-of-the-azure-storage-domain-manager" title="Limitations of the Azure Storage Domain Manager" class="md-nav__link">
    Limitations of the Azure Storage Domain Manager
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/edit/master/docs/chapter3/domainmgr.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="the-domain-manager">The Domain Manager<a class="headerlink" href="#the-domain-manager" title="Permanent link">&para;</a></h1>
<p>As a request comes in to the mobile backend, it is processed through several layers.  First, ASP.NET
processes the request, handling things like Authentication and Authorization.  It is then processed
through the <code>Microsoft.Web.Http.OData</code> controller, which compiles the requested query.  Then it is 
passed to the Domain Manager, which is responsible for converting the request into a response.  The
response is then passed back up the stack to be finally given back to the mobile client.</p>
<p>The Domain Manager is a central part of this process.  It is a class that implements the <code>IDomainManager</code>
interface:</p>
<pre><code class="csharp">namespace Microsoft.Azure.Mobile.Server.Tables
{
    public interface IDomainManager&lt;TData&gt; where TData : class, ITableData
    {
        IQueryable&lt;TData&gt; Query();
        SingleResult&lt;TData&gt; Lookup(string id);
        Task&lt;IEnumerable&lt;TData&gt;&gt; QueryAsync(ODataQueryOptions query);
        Task&lt;SingleResult&lt;TData&gt;&gt; LookupAsync(string id);
        Task&lt;TData&gt; InsertAsync(TData data);
        Task&lt;TData&gt; UpdateAsync(string id, Delta&lt;TData&gt; patch);
        Task&lt;TData&gt; ReplaceAsync(string id, TData data);
        Task&lt;bool&gt; DeleteAsync(string id);
    }
}
</code></pre>

<p>This looks deceptively simple.  Just 8 methods.  In reality, this is anything but simple.  The major issue
that a prospective domain manager implementor has to grapple with is the translation of an <code>IQueryable</code> into
something that the backend data source can understand.</p>
<p>Let's take a look at a couple of domain managers that solve specific problems that crop up from time to time
during development.  It should be noted that <strong>NEITHER</strong> of these domain managers are recommended as a generalized
solution.  They both have significant caveats to their use and you should understand those caveats before
embarking on integrating them.</p>
<h2 id="existing-table-relationships-with-the-mappedentitydomainmanager">Existing Table Relationships with the MappedEntityDomainManager<a class="headerlink" href="#existing-table-relationships-with-the-mappedentitydomainmanager" title="Permanent link">&para;</a></h2>
<p>One of the key areas that is weak when using the default <code>EntityDomainManager</code> is handling existing tables.  The
generally accepted method of dealing with relationships is through loose coupling and manual relationship management
in the client. Relationships are core to the SQL database world and we sometimes want to project those relationships 
into the mobile client, allowing the backend to preserve any relationships that have been configured while still 
using the standard offline client capabilities.  If you have existing SQL relationships, you can use a combination
of <a href="http://automapper.org/">AutoMapper</a> and the <code>MappedEntityDomainManager</code>.  </p>
<p>The <code>MappedEntityDomainManager</code> is an abstract <code>IDomainManager</code> implementation targetting SQL as the backend store where
there is not a 1:1 mapping between the data object (DTO) exposed through the TableController and the domain model managed 
by Entity Framework.  If there is a 1:1 mapping, use <code>EntityDomainManager</code>.  The <code>MappedEntityDomainManager</code> uses 
<a href="http://automapper.org/">AutoMapper</a> to map between the DTO and the domain model.  It assumes that AutoMapper has already been initialized with 
appropriate mappings that map from DTO to domain model and from the domain model to the DTO.</p>
<p>Let's take a small example.  If I am producing an enterprise mobile app that field engineers can use - the ones
that, for example, visit your house to install cable.  I can define an Entity Framework model map as follows:</p>
<pre><code class="csharp">[Table(&quot;Customers&quot;)]
public class Customer
{
    public Customer()
    {
        this.Jobs = new HashSet&lt;Job&gt;();
    }

    [StringLength(50)]
    public string Id { get; set; }

    [StringLength(50)]
    public string FullName { get; set; }

    [StringLength(250)]
    public string Address { get; set; 

    public decimal? Latitude { get; set; }

    public decimal? Longitude { get; set; }

    public ICollection&lt;Job&gt; Jobs { get; set; }
}

[Table(&quot;Equipment&quot;)]
public class Equipment : ITableData
{
    public Equipment()
    {
        this.Jobs = new HashSet&lt;Job&gt;();
    }

    [StringLength(50)]
    public string Name { get; set; }

    [StringLength(28)]
    public string Asset { get; set; }

    [StringLength(250)]
    public string Description { get; set; }

    #region ITableData
    public DateTimeOffset? CreatedAt { get; set; }
    public bool Deleted { get; set; }

    [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
    public DateTimeOffset? UpdatedAt { get; set; }

    [Timestamp]
    public byte[] Version { get; set; }
    #endregion

    public ICollection&lt;Job&gt; Jobs { get; set; }
}

[Table(&quot;Jobs&quot;)]
public class Job : ITableData
{
    public Job()
    {
        this.Equipments = new HashSet&lt;Equipment&gt;();
    }

    [StringLength(50)]
    public string CustomerId { get; set; }

    [StringLength(50)]
    public string AgentId { get; set; }

    public DateTimeOffset? StartTime { get; set; }

    public DateTimeOffset? EndTime { get; set; }

    [StringLength(50)]
    public string Status { get; set; }

    [StringLength(250)]
    public string Description { get; set; }

    #region ITableData
    public DateTimeOffset? CreatedAt { get; set; }
    public bool Deleted { get; set; }

    [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
    public DateTimeOffset? UpdatedAt { get; set; }

    [Timestamp]
    public byte[] Version { get; set; }
    #endregion

    public ICollection&lt;Equipment&gt; Equipments { get; set; }
}
</code></pre>

<p>This is the representation of the tables within the database.  They don't have to map to what the client
requires.  We can wire up the relationships in the normal <a href="http://www.entityframeworktutorial.net/code-first/configure-one-to-one-relationship-in-code-first.aspx">Entity Framework way</a>, within the <code>DbContext</code>:</p>
<pre><code class="csharp">public partial class ExistingDbContext : DbContext
{
    public FieldDbContext() : base(&quot;name=MS_TableConnectionString&quot;)
    {            
    }

    public virtual DbSet&lt;Customer&gt; Customers { get; set; }
    public virtual DbSet&lt;Equipment&gt; Equipments { get; set; }
    public virtual DbSet&lt;Job&gt; Jobs { get; set; } 

    protected override void OnModelCreating(DbModelBuilder modelBuilder)
    {            
        modelBuilder.HasDefaultSchema(&quot;dbo&quot;);
        modelBuilder.Conventions.Add(
            new AttributeToColumnAnnotationConvention&lt;TableColumnAttribute, string&gt;(
            &quot;ServiceTableColumn&quot;, (property, attributes) =&gt; attributes.Single().ColumnType.ToString()));

        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.Address).IsUnicode(false);
        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.FullName).IsUnicode(false);
        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.Id).IsUnicode(false);
        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.Latitude).HasPrecision(9, 6);
        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.Longitude).HasPrecision(9, 6);

        modelBuilder.Entity&lt;Equipment&gt;().Property(e =&gt; e.Asset).IsUnicode(false);
        modelBuilder.Entity&lt;Equipment&gt;().Property(e =&gt; e.Description).IsUnicode(false);
        modelBuilder.Entity&lt;Equipment&gt;().Property(e =&gt; e.Name).IsUnicode(false);
        modelBuilder.Entity&lt;Equipment&gt;().Property(e =&gt; e.Id).IsUnicode(false);

        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.CustomerId).IsUnicode(false);
        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.AgentId).IsUnicode(false);
        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.Id).IsUnicode(false);
        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.Status).IsUnicode(false);
        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.Description).IsUnicode(false);

        modelBuilder.Entity&lt;Equipment&gt;()
            .HasMany(e =&gt; e.Jobs)
            .WithMany(e =&gt; e.Equipments)
            .Map(m =&gt; m.ToTable(&quot;EquipmentIds&quot;).MapLeftKey(&quot;EquipmentId&quot;).MapRightKey(&quot;JobId&quot;));
    }
}
</code></pre>

<p>We can see the relationship (a Many:Many relationship) at the end of the <code>modelBuilder</code> within
the DbContext.  The 1:Many and 1:1 relationships are handled within the models themselves, per the
normal Entity Framework methods. This is pure Entity Framework thus far - we have defined the
structure of the database.</p>
<p>To translate this into a mobile client, we need to define Data Transfer Objects.  These don't
have to be the same shape as the models that Entity Framework is using.  For example:</p>
<pre><code class="csharp">public class CustomerDTO
{
    public string FullName { get; set; }
    public string Address { get; set; 
    public decimal? Latitude { get; set; }
    public decimal? Longitude { get; set; }
}

public class EquipmentDTO
{
    public string Name { get; set; }
    public string Asset { get; set; }
    public string Description { get; set; }
}

public class JobDTO : EntityData
{
    public string AgentId { get; set; }
    public DateTimeOffset? StartTime { get; set; }
    public DateTimeOffset? EndTime { get; set; }
    public string Status { get; set; }
    public string Description { get; set; }  

    public virtual CustomerDTO Customer { get; set; }
    public virtual List&lt;EquipmentDTO&gt; Equipments { get; set; }
}
</code></pre>

<p>Note that the DTOs are similar, but definitely not the same.  They don't have the same relationships between
the records, for example.  <code>MappedEntityDomainManager</code> requires that AutoMapper is already configured and
initialized, so that's the next step.  Set up an AutoMapper configuration in the <code>App_Start</code> directory:</p>
<pre><code class="csharp">using AutoMapper;
using FieldEngineer.Service.DataObjects;
using FieldEngineer.Service.Models;

namespace FieldEngineer.Service
{
    public class AutomapperConfiguration
    {
        public static void CreateMapping(IConfiguration cfg)
        {
            // Apply some name changes from the entity to the DTO
            cfg.CreateMap&lt;Job, JobDTO&gt;()                
                .ForMember(jobDTO =&gt; jobDTO.Equipments, map =&gt; map.MapFrom(job =&gt; job.Equipments));

            // For incoming requests, ignore the relationships
            cfg.CreateMap&lt;JobDTO, Job&gt;()                                            
                .ForMember(job =&gt; job.Customer, map =&gt; map.Ignore())
                .ForMember(job =&gt; job.Equipments, map =&gt; map.Ignore());

            cfg.CreateMap&lt;Customer, CustomerDTO&gt;();            
            cfg.CreateMap&lt;Equipment, EquipmentDTO&gt;();
        }
    }
}
</code></pre>

<p>You will also need to initialize the AutoMapper - this can be done where you also configure the Azure Mobile Apps:</p>
<pre><code class="csharp">using System;
using System.Web.Http;
using AutoMapper;
using Microsoft.WindowsAzure.Mobile.Service;

namespace FieldEngineer.Service
{
    public static class WebApiConfig
    {
        public static void Register()
        {
            // Use this class to set configuration options for your mobile service
            ConfigOptions options = new ConfigOptions();

            // Use this class to set WebAPI configuration options
            HttpConfiguration config = ServiceConfig.Initialize(new ConfigBuilder(options));

            // To display errors in the browser during development, uncomment the following
            // line. Comment it out again when you deploy your service for production use.
            config.IncludeErrorDetailPolicy = IncludeErrorDetailPolicy.Always;

            // This is the line that initializes AutoMapper
            Mapper.Initialize(cfg =&gt; { AutomapperConfiguration.CreateMapping(cfg); });                                
        }
    }
}
</code></pre>

<p>Finally, we can create a controller that allows the receipt and update of jobs:</p>
<pre><code class="csharp">namespace FieldEngineer.Service.Controllers
{
    [Authorize]  
    public class JobController : TableController&lt;JobDTO&gt;
    {      
        private FieldDbContext context;        

        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            this.context = new FieldDbContext();

            this.DomainManager = new DefaultMappedEntityDomainManager&lt;JobDTO,Job&gt;(this.context, Request, Services);            
        }

        [ExpandProperty(&quot;Customer&quot;)]
        [ExpandProperty(&quot;Equipments&quot;)]
        public async Task&lt;IQueryable&lt;JobDTO&gt;&gt; GetAllJobs()
        {                        
            var jobs = this.context.Jobs
                .Include(&quot;Customer&quot;)
                .Include(&quot;Equipments&quot;)
                .Project().To&lt;JobDTO&gt;();            
            return jobs;
        }

        [ExpandProperty(&quot;Customer&quot;)]
        [ExpandProperty(&quot;Equipments&quot;)]
        public SingleResult&lt;JobDTO&gt; GetJob(string id)
        {
            return this.Lookup(id);
        }

        public async Task&lt;JobDTO&gt; PatchJob(string id, Delta&lt;JobDTO&gt; patch)
        {
            return await this.UpdateAsync(id, patch);                   
        }        
    }
}
</code></pre>

<p>We are using <code>[ExpandProperty]</code> to expand the Customer and Equipment data so that it is transferred with the Job object.
The <code>MappedEntityDomainManager</code> is an abstract type, so we have to create a concrete implementation.  Fortunately, most
of the work is done for us.  There are already concrete versions of most of the methods we require (like insert, delete
and lookup). The <code>MappedEntityDomainManager</code> needs help to deal with replacements nor optimistic concurrency - features 
we want.  We can use the <code>DefaultMappedEntityDomainManager</code>to handle this for us:</p>
<pre><code class="csharp">namespace FieldEngineerLite.Service.Helpers
{
    public class DefaultMappedEntityDomainManager&lt;TData, TModel&gt;
            : MappedEntityDomainManager&lt;TData, TModel&gt;
        where TData : class, ITableData
        where TModel : class, ITableData
    {
        public DefaultMappedEntityDomainManager(DbContext context, HttpRequestMessage request, ApiServices services)
            : base(context, request, services)
        {            
        }

        public override Task&lt;bool&gt; DeleteAsync(string id)
        {
            return this.DeleteItemAsync(id);
        }

        public override Task&lt;TData&gt; UpdateAsync(string id, Delta&lt;TData&gt; patch)
        {
            return this.UpdateEntityAsync(patch, id);
        }

        public override SingleResult&lt;TData&gt; Lookup(string id)
        {
            return this.LookupEntity(model =&gt; model.Id == id);
        }

        protected override void SetOriginalVersion(TModel model, byte[] version)
        {            
            this.Context.Entry(model).OriginalValues[&quot;Version&quot;] = version;
        }
    }
}
</code></pre>

<p>The primary thing that the <code>DefaultMappedEntityDomainManager</code> does that the original doesn't is in the <code>SetOriginalVersion</code>
method.  This causes the model to be updated with a new version, allowing for conflict detection in the domain manager.</p>
<p>If we move now to the models on the mobile client, we see some fairly standard models:</p>
<pre><code class="csharp">public class Customer
{
    public string Id { get; set; }
    public string FullName { get; set; }
    public string Address { get; set; 
    public decimal? Latitude { get; set; }
    public decimal? Longitude { get; set; }
}

public class Equipment
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Asset { get; set; }
    public string Description { get; set; }
}

public class Job
{
    public const string CompleteStatus = &quot;Completed&quot;;
    public const string InProgressStatus = &quot;On Site&quot;;
    public const string PendingStatus = &quot;Not Started&quot;;

    public string Id { get; set; }
    public string AgentId { get; set; }
    public DateTimeOffset? StartTime { get; set; }
    public DateTimeOffSet? EndTime { get; set; }
    public string Status { get; set; }
    public string Description { get; set; }

    public Customer Customer { get; set; }
    public List&lt;Equipment&gt; Equipments { get; set; }

    [Version]
    public string Version { get; set; }
}
</code></pre>

<p>In this case, we only need to sync the Job table, so we can define it in the <code>InitializeAsync()</code> method on the client:</p>
<pre><code class="csharp">public async Task InitializeAsync()
{
        var store = new MobileServiceSQLiteStore(&quot;localdata.db&quot;);
        store.DefineTable&lt;Job&gt;();
        await MobileService.SyncContext.InitializeAsync(store);
}
</code></pre>

<p>You can use <code>GetSyncTable&lt;Job&gt;()</code> to get a reference to the table and deal with it as you normally would.  I'd expect in this
case that the Customer and Equipment would be handled elsewhere - maybe a separate web application that customer service
agents use, for example.</p>
<p>So, what are the caveats?  The first is that the Job, Customer and Equipment data all comes down as one record.  This has a 
side effect of ensuring that the Customer and Equipment data is read-only.  You can only update the information in the Job
table.  This is also a very time consuming process to set up properly.  Automapper is known as a fairly picky piece of 
software to integrate, so extra time must be allotted to make it work correctly.</p>
<p>In the end, I prefer handling tables individually and handling relationship management on the mobile client manually.  This
causes more code on the mobile client but makes the server much simpler by avoiding most of the complexity of relationships.</p>
<h2 id="nosql-storage-with-the-storagedomainmanager">NoSQL Storage with the StorageDomainManager<a class="headerlink" href="#nosql-storage-with-the-storagedomainmanager" title="Permanent link">&para;</a></h2>
<p>What if you don't want to use a SQL backend for your service?  Relationships between entities are not that important in the mobile client and Azure Table Storage costs significantly less than SQL Azure.  There are always trade-offs between various storage providers.  A Domain Manager enables you to swap out the storage for one of your own choosing.  Azure Mobile Apps provides a domain manager for Azure Table Storage.  Azure Table Storage is Microsoft's NOSQL key/attribute store.  It has a schemaless design, which (at least theoretically) enables you to adapt your data models as the application evolves without having to worry about the schema.</p>
<p>To see this in action, let's rework the existing data store (which has tags and todoitems as tables) to use Table Storage.  First up, we need to set up a suitable environment.  This involves:</p>
<ol>
<li>Create a Resource Group</li>
<li>Create an Azure App Service</li>
<li>Set up authentication on the Azure App Service</li>
<li>Create a Storage Account</li>
<li>Link the Storage Account to the Azure App Service.</li>
</ol>
<p>We've already covered the first three items in previous chapters.  The important element here is that we do not create a SQL database.  We are going to be using Table Storage instead so we don't need it.  To create a Storage Account:</p>
<ul>
<li>Log on to the <a href="https://portal.azure.com/">Azure portal</a>.</li>
<li>Click the big <strong>+ NEW</strong> button in the top left corner.</li>
<li>Click <strong>Data + Storage</strong>, then <strong>Storage account</strong>.</li>
<li>Fill in the form:<ul>
<li>The name can only contain letters and numbers and must be unique.  A GUID without the dashes is a good choice.</li>
<li>The <strong>Deployment model</strong> should be set to <strong>Resource manager</strong>.</li>
<li>The <strong>Account kind</strong> should be set to <strong>General purpose</strong>.</li>
<li>The <strong>Performance</strong> should be set to <strong>Standard</strong> for this example.</li>
<li>The <strong>Replication</strong> should be set to <strong>Locally-redundant storage (LRS)</strong>.</li>
<li>Set the <strong>Resource group</strong> to your existing resource group.</li>
<li>Set the <strong>Location</strong> to the same location as your App Service.</li>
</ul>
</li>
<li>Click <strong>Create</strong>.</li>
</ul>
<p>Just like SQL Azure, Azure Storage has some great scalability and redundancy features if your backend takes advantage of them. We have selected the slowest performance and least redundant options here to keep the cost down on your service.</p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>There is no "free" option for Azure Storage.  You pay by the kilobyte depending on the performance and redundancy selected.</p>
</div>
<p>Once the Azure Storage account is deployed, you can link the storage account to your App Service:</p>
<ul>
<li>Open your App Service in the <a href="https://portal.azure.com/">Azure portal</a>.</li>
<li>Click  <strong>Data Connections</strong> under the <strong>MOBILE</strong> section in the settings menu.</li>
<li>Click <strong>+ ADD</strong></li>
<li>In the <strong>Add data connection</strong> blade:<ul>
<li>Set the Type to <strong>Storage</strong>.</li>
<li>Click the <strong>Storage</strong> link.</li>
<li>In the <strong>Storage Account</strong> selector, click the storage account you just created.</li>
<li>Click the <strong>Connection string</strong>.</li>
<li>In the <strong>Connection string</strong> selector, make a note of the <strong>Name</strong> field.</li>
<li>Click <strong>OK</strong>.</li>
<li>Click <strong>OK</strong> to close the <strong>Add data connection</strong> blade.</li>
</ul>
</li>
</ul>
<p>Click on the <strong>Application Settings</strong> menu option, then scroll down to the <strong>Connection Strings</strong> section.  Note that the portal has created the connection string as an App Setting for you with the right value:</p>
<pre><code class="bash">DefaultEndpointsProtocol=https;AccountName=thebook;AccountKey=&lt;key1&gt;
</code></pre>

<p>The key is the access key for the storage.  When a storage account is created, two keys are also created.  If you re-generate the storage access keys, remember to update your connection string.  By default, the connection string is called <code>MS_AzureStorageAccountConnectionString</code> and we will use that throughout.</p>
<p>Now that our resources are set up, let's look at the Backend project.  This started off as a standard Azure Mobile Apps template.  The template assumes you are going to use SQL Azure, so there is quite a bit of work to convert the provided template to use Azure Table Storage.  Let's start with the <code>App_Start\Startup.MobileApp.cs</code> file.  There is no Entity Framework, so that needs to be stripped out:</p>
<pre><code class="csharp">using System.Configuration;
using System.Web.Http;
using Microsoft.Azure.Mobile.Server;
using Microsoft.Azure.Mobile.Server.Authentication;
using Microsoft.Azure.Mobile.Server.Config;
using Owin;

namespace Backend
{
    public partial class Startup
    {
        public static void ConfigureMobileApp(IAppBuilder app)
        {
            HttpConfiguration config = new HttpConfiguration();

            new MobileAppConfiguration()
                .AddTables()
                .ApplyTo(config);

            app.UseWebApi(config);
        }
    }
}
</code></pre>

<p>We've made three changes:</p>
<ol>
<li>We've removed the database seeding.</li>
<li>We've removed the database initializer.</li>
<li>We've changed <code>AddTablesWithEntityFramework()</code> to <code>AddTables()</code>.</li>
</ol>
<p>There is extra work needed with Entity Framework.  Since we aren't using it, we don't need the additional work.  We do, however, need to create the ASP.NET routes to the table controllers.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You must add the <code>Microsoft.Azure.Mobile.Server.Storage</code> package from NuGet. </p>
</div>
<p>Let's move onto the DataObjects.  These are very similar:</p>
<pre><code class="csharp">namespace Backend.DataObjects
{
    public class TodoItem : StorageData
    {
        public string Text { get; set; }
        public bool Complete { get; set; }
    }
}
</code></pre>

<p>Each storage implementation will likely need their own implementation of the <code>ITableData</code> interface.  The <code>StorageData</code> class performs the same duties as the <code>EntityData</code> class for Entity Framework based backends.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can remove the <code>Models</code> directory and the <code>DbContext</code> for the project.  These are only needed when working with Entity Framework.</p>
</div>
<p>The Azure Table Storage SDK is completely async driven.  Fortunately, the domain manager specification (codified in the definition of <code>IDomainManager</code>) allows both async and synchronous usage.  This does require a change to our controller:</p>
<pre><code class="csharp">using System.Collections.Generic;
using System.Threading.Tasks;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.OData;
using System.Web.Http.OData.Query;
using Backend.DataObjects;
using Microsoft.Azure.Mobile.Server;

namespace Backend.Controllers
{
    public class TodoItemController : TableController&lt;TodoItem&gt;
    {
        const string connectionString = &quot;MS_AzureStorageAccountConnectionString&quot;;
        const string tableName = &quot;TodoItem&quot;;

        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            DomainManager = new StorageDomainManager&lt;TodoItem&gt;(connectionString, tableName, Request, enableSoftDelete: true);
        }

        // GET tables/TodoItem
        public async Task&lt;IEnumerable&lt;TodoItem&gt;&gt; GetAllTodoItemsAsync(ODataQueryOptions query)
        {
            return await QueryAsync(query);
        }

        // GET tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public async Task&lt;SingleResult&lt;TodoItem&gt;&gt; GetTodoItemAsync(string id)
        {
            return await LookupAsync(id);
        }

        // PATCH tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public async Task&lt;TodoItem&gt; PatchTodoItemAsync(string id, Delta&lt;TodoItem&gt; patch)
        {
            return await UpdateAsync(id, patch);
        }

        // POST tables/TodoItem
        public async Task&lt;IHttpActionResult&gt; PostTodoItemAsync(TodoItem item)
        {
            TodoItem current = await InsertAsync(item);
            return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
        }

        // DELETE tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public async Task DeleteTodoItemAsync(string id)
        {
            await DeleteAsync(id);
        }
    }
}
</code></pre>

<p>Note how we instantiate the storage domain controller.  This requires a connection string and the name of the table.  We have created the connection string in the portal, but we have not exposed that connection string to our ASP.NET application. We need to edit the <code>Web.config</code> file as well:</p>
<pre><code class="xml">&lt;connectionStrings&gt;
    &lt;add name=&quot;MS_AzureStorageAccountConnectionString&quot; connectionString=&quot;UseDevelopmentStorage=true&quot;/&gt;
&lt;/connectionStrings&gt;
</code></pre>

<p>This will be overwritten by the connection string in the portal.  If you are running the service locally, you can use this
setting with the Azure Storage Emulator.  If you don't add this line to the <code>Web.config</code>, you will not be able to run this
server locally.</p>
<p>This backend can now be published and we can work with Postman to test it out.  For instance, let's try adding a simple test
of getting some data:</p>
<p><img alt="" src="../img/storage-1.PNG" /></p>
<p>This is exactly the same response as we got when we don't have any data from the Entity Framework version.  Let's add a 
record:</p>
<p><img alt="" src="../img/storage-2.PNG" /></p>
<p>There are a couple of things to note here.  Firstly, the Id must be specified.  It also must be of a specific form.  There are two numbers.  The first is a partition key and the second is a row key.  Tables are partitioned to support load balancing across storage notes.  It can be anything you wish it to be.  Similarly, the row key is unique within a partition.  We can use this information to generate a suitable Id if one is not provided:</p>
<pre><code class="csharp">// POST tables/TodoItem
public async Task&lt;IHttpActionResult&gt; PostTodoItemAsync(TodoItem item)
{
    if (item.Id == null || item.Id == &quot;'',''&quot;)
    {
        item.Id = GenerateUniqueId();
    }
    TodoItem current = await InsertAsync(item);
    return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
}

private string GenerateUniqueId()
{
    var partitionId = &quot;1&quot;;
    var rowId = Guid.NewGuid().ToString(&quot;N&quot;);
    return $&quot;'{partitionId}','{rowId}'&quot;;
}
</code></pre>

<p>The value <code>'',''</code> is the default value of the Id column.  However, that is not good enough to get a successful store.  This code
generates a unique identifier in the right format.  A single partition is reasonable for most applications.  If you intend on
storing massive amounts of data, the data partitioning scheme will require some consideration (just like any other NoSQL application).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You will need a copy of the <code>GenerateUniqueId()</code> method if you generate unique identifiers for your records within 
your mobile client.  The partition key and row key are returned as part of the record.  </p>
</div>
<p>You can use the <strong>Cloud Explorer</strong> if you wish to see the data stored in Azure Table Storage.  Expand the <strong>Storage Accounts</strong> node,
then expand the appropriate nodes: your storage account, <strong>Tables</strong>, <strong>TodoItem</strong>.  You can open the table editor or delete the table
from there.  </p>
<p><img alt="" src="../img/storage-3.PNG" /></p>
<p>Within the table editor, you can right-click on any row to delete or edit values.  This will update the time stamp and etag, ensuring
that your mobile clients are updated as well.</p>
<h3 id="limitations-of-the-azure-storage-domain-manager">Limitations of the Azure Storage Domain Manager<a class="headerlink" href="#limitations-of-the-azure-storage-domain-manager" title="Permanent link">&para;</a></h3>
<p>There are, of course, caveats to working in Azure Mobile Apps with Azure Table Storage.   There are three major caveats that you should
be aware of.</p>
<ol>
<li>There are no relationships possible with Azure Table Storage.</li>
<li>Only <code>$filter</code>, <code>$top</code> and <code>$select</code> are supported in the URI.</li>
<li>Offline sync only supports flat objects.</li>
</ol>
<p>Let's take a look at each in turn.</p>
<p><strong>No relationhips</strong></p>
<p>You have to work at relationships and relationships between entities are severely restricted in Entity Framework.  However, they are
possible.  Not so with Azure Table Storage.  The NoSQL store has no concept of a relationship of any description.  This is not a major
caveat since your mobile client similarly has no notion of relationships.  Just treat every table as distinct.</p>
<p><strong>Limited support for OData query options</strong></p>
<p>Only <code>$filter</code>, <code>$top</code> and <code>$select</code> are <a href="https://msdn.microsoft.com/en-us/library/azure/dd894031.aspx">supported by the OData interface</a>.  Since the Azure Table Storage Domain Manager passes the 
incoming OData query to the Storage driver intact, this limitation is passed on to the OData interface for Azure Mobile Apps.  Specifically, 
this means paging is handled differently.  With the <code>EntityDomainManager</code>, paging was accomplished by using <code>$skip</code> and <code>$top</code> to get more
records until zero records were returned.  With the <code>StorageDomainManager</code>, a <code>Link</code> header is returned when there are more records.</p>
<p><img alt="" src="../img/storage-4.PNG" /></p>
<p>The <code>Link</code> header contains the URI that you need to retrieve to get the next page of the results.  This has implications for how you 
receive more than 50 records.</p>
<p><strong>Offline sync only supports "flat" objects</strong></p>
<p>One of the common reasons for using NoSQL stores is that you can store pretty much any document you wish.  You just have to have a JSON
representation of the object cross the wire.  If you have complex objects stored in Azure Table Storage, they won't be able to be stored
in the offline cache.  The offline cache is based on SQLite and inherits the limitations of that resource.  In particular, this means no
complex types.</p>
<p>Using a NoSQL store seems like a great idea.  However, the limitations of the platform make Azure Table Storage a poor choice for this
particular function.  The Azure Table Storage is ill-suited to the demands of a mobile client backend.</p>
<p>One of the great uses of the Azure Table Storage Domain Manager is to see how you can write your own domain manager.  The <a href="https://github.com/Azure/azure-mobile-apps-net-server/blob/master/src/Microsoft.Azure.Mobile.Server.Storage/StorageDomainManager.cs">code</a> for
the domain manager (and the ITableData interface) is relatively simple since it passes through the OData query to Azure Storage.  This
allows you to see what is truly involved in writing a domain manager.</p>
<!-- Images -->

<!-- Links -->
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../relationships/" title="Relationships" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Relationships
              </span>
            </div>
          </a>
        
        
          <a href="../../chapter4/options/" title="Options for Server Code" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Options for Server Code
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 Adrian Hall
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/adrianhall" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/FizzyInTheHall" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.a353778b.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../js/highlight.pack.js"></script>
      
    
  </body>
</html>